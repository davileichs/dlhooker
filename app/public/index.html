<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Webhook Inspector</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      max-width: 100vw;
      overflow-x: hidden;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 15px;
      background: #022128;
      height: 100vh;
      min-height: 100vh;
      color: #fff;
      box-sizing: border-box;
      max-width: 100vw;
      overflow-x: hidden;
    }
    #container {
      display: flex;
      width: 100%;
      max-width: 100vw;
      margin: 0;
      background: #022128;
      border-radius: 12px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.08);
      padding: 24px;
      box-sizing: border-box;
      gap: 24px;
      min-height: 80vh;
      /* Remove margin-left, use padding-left for sidebar */
      padding-left: 344px;
    }
    #sidebar {
      width: 320px;
      background: #022128;
      color: #fff;
      border-radius: 8px;
      padding: 0 0 0 0;
      display: flex;
      flex-direction: column;
      min-width: 220px;
      max-width: 340px;
      height: 100vh;
      min-height: 0;
      box-sizing: border-box;
      overflow: hidden;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 100;
    }
    #sidebar-header { padding: 20px 20px 10px 20px; border-bottom: 1px solid #1a3a3a; }
    #webhook-url { word-break: break-all; }
    #callback-list {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      list-style: none;
      margin: 0;
      padding: 0 0 0 0;
      min-height: 0;
      height: 0;
      /* Fills remaining sidebar height */
    }
    .callback-link { display: block; padding: 14px 20px; border-bottom: 1px solid #1a3a3a; color: #fff; text-decoration: none; cursor: pointer; transition: background 0.2s; }
    .callback-link.selected, .callback-link:hover { background: #1a3a3a; }
    #main {
      flex: 1;
      padding: 0 8px;
      border-radius: 8px;
      background: #022128;
      min-height: 0;
      color: #fff;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      /* Remove overflow and height for page scroll */
    }
    #main h2 { margin-top: 0; color: #fff; }
    #payload-details { color: #fff; }

    .json-body {
      background: #0e2c38;
      color: #fff;
      padding: 20px 24px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 1.08em;
      line-height: 1.6;
      border: 1px solid #1a3a3a;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      margin-top: 10px;
      white-space: pre-wrap; /* This ensures text wraps */
      word-wrap: break-word; /* This ensures long words break and wrap onto the next line */
    }

    .query-body {
      background: #0e2c38;
      color: #fff;
      padding: 20px 24px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 1.08em;
      line-height: 1.6;
      border: 1px solid #1a3a3a;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      margin-top: 10px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .json-key { color: #f7c873; }
    .json-string { color: #7fffd4; }
    .json-number { color: #ffd700; }
    .json-boolean { color: #87cefa; }
    .json-null { color: #f1fa8c; }
    .copy-btn { margin-left: auto; padding: 2px 8px; font-size: 0.95em; cursor: pointer; border-radius: 4px; border: none; background: #1a3a3a; color: #fff; }
    .copy-btn:hover { background: #2e4d4d; }
    .header-key { font-weight: bold; }
    .header-value { font-family: monospace; }
    table { color: #fff; }
    th, td { background: transparent; }
    .http-method-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 54px;
      max-width: 70px;
      height: 22px;
      padding: 0 10px;
      border-radius: 12px;
      border: 1.5px solid #fff;
      background: #444;
      color: #fff;
      font-size: 11px;
      font-weight: bold;
      letter-spacing: 0.5px;
      vertical-align: middle;
      margin-left: 8px;
      transition: background 0.2s, color 0.2s;
      text-align: center;
      box-sizing: border-box;
      text-transform: uppercase;
    }
    .http-method-get {
      background: #2ecc40;
      border-color: #2ecc40;
      color: #fff;
    }
    .http-method-post {
      background: #0074d9;
      border-color: #0074d9;
      color: #fff;
    }
    .http-method-put {
      background: #ff851b;
      border-color: #ff851b;
      color: #fff;
    }
    .http-method-delete {
      background: #ff4136;
      border-color: #ff4136;
      color: #fff;
    }
    .http-method-patch {
      background: #b10dc9;
      border-color: #b10dc9;
      color: #fff;
    }
    .http-method-default {
      background: #666;
      border-color: #666;
      color: #fff;
    }
    .webhook-url-bar {
      display: flex;
      align-items: center;
      background: #fff;
      border-radius: 6px;
      padding: 10px 12px;
      width: 100%;
      min-width: 0;
      max-width: 100%;
      box-sizing: border-box;
      gap: 10px;
      margin: 0 0 18px 0;
      position: static;
      top: unset;
      right: unset;
      z-index: 1;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      border: 1.5px solid #e0e0e0;
    }
    .webhook-url-label {
      color: #022128;
      font-size: 0.93em;
      font-weight: bold;
    }
    .webhook-url-text {
      flex: 1;
      color: #022128;
      font-size: 0.92em;
      word-break: break-all;
      user-select: all;
      background: none;
    }
    .copy-webhook-btn {
      background: #0074d9;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 4px 12px;
      font-size: 0.92em;
      cursor: pointer;
      margin-left: 8px;
      transition: background 0.2s;
      font-weight: bold;
    }
    .copy-webhook-btn:hover {
      background: #005fa3;
    }
    .callback-link-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }
 
    .headers-table-row {
      border-bottom: 1px solid #fff;
    }
    .headers-table-row:last-child {
      border-bottom: none;
    }
    .headers-table-cell {
      padding: 12px 8px;
      vertical-align: middle;
    }
    .reset-btn {
      background: #ff4136;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 6px 18px;
      font-size: 0.98em;
      cursor: pointer;
      font-weight: bold;
      margin-left: 12px;
      transition: background 0.2s;
    }
    .reset-btn:hover {
      background: #c12b1e;
    }
    @media (max-width: 900px) {
      html, body { max-width: 100vw; overflow-x: hidden; }
      #container {
        flex-direction: column;
        height: auto;
        min-height: 100vh;
        max-width: 100vw;
        margin: 0;
        padding: 8px;
        border-radius: 0;
        box-shadow: none;
        gap: 12px;
        padding-left: 0;
      }
      #sidebar, #main {
        width: 100%;
        min-width: 0;
        max-width: 100vw;
        border-radius: 0;
        height: auto;
        padding: 0;
      }
      #sidebar {
        position: static;
        top: unset;
        left: unset;
        z-index: 1;
        max-height: none;
        min-height: 120px;
        height: auto;
        overflow-y: visible;
      }
      #callback-list {
        max-height: none;
        min-height: 80px;
        height: auto;
        overflow-y: auto;
      }
      #sidebar-header { padding: 16px 10px 8px 10px; }
      .webhook-url-bar {
        flex-direction: column;
        align-items: flex-start;
        padding: 8px 8px;
        margin-bottom: 10px;
        min-width: 0;
        max-width: 100vw;
        font-size: 0.95em;
      }
      .webhook-url-label { margin-bottom: 2px; }
      .webhook-url-text { font-size: 0.93em; }
      .copy-webhook-btn { width: 100%; margin: 8px 0 0 0; }
      .json-body { padding: 12px 8px; font-size: 0.98em; }
      h2 { font-size: 1.1em; }
      #main {
        max-height: none;
        height: auto;
        overflow-y: visible;
      }
    }
  </style>
</head>
<body style="position:relative;">
  <div id="container">
    <div id="sidebar">
      <div id="sidebar-header">
        <h2 style="margin:0 0 10px 0; font-size: 1.2em;">Webhook Inspector</h2>
      </div>
      <ul id="callback-list"></ul>
    </div>
    <div id="main">
      <div class="webhook-url-bar">
        <span class="webhook-url-label" style="font-size:0.97em;margin-right:8px;">Webhook URL:</span>
        <span id="webhook-url" class="webhook-url-text"></span>
        <button id="copy-webhook-btn" class="copy-webhook-btn">Copy</button>
      </div>
      <button id="reset-btn" class="reset-btn" style="margin-bottom:18px;align-self:flex-end;">Reset All</button>
      <h2>Payload Details</h2>
      <div id="payload-details">No callback selected.</div>
      <div id="copy-success" style="color:green;display:none;margin-top:8px;">Copied!</div>
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Generate or retrieve a unique session ID
    function uuidv4() {
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      );
    }
    let sessionId = localStorage.getItem('sessionId');
    if (!sessionId) {
      sessionId = uuidv4();
      localStorage.setItem('sessionId', sessionId);
    }
    const webhookUrl = `${window.location.origin}/webhook/${sessionId}`;
    document.getElementById('webhook-url').textContent = webhookUrl;
    document.getElementById('copy-webhook-btn').onclick = function() {
      navigator.clipboard.writeText(webhookUrl);
      showCopySuccess();
    };

    const socket = io({ query: { sessionId } });
    let payloads = [];
    let selectedIdx = null;

    const callbackList = document.getElementById('callback-list');
    const payloadDetails = document.getElementById('payload-details');

    function formatDateEU(ts) {
      const d = new Date(ts);
      const pad = n => n.toString().padStart(2, '0');
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function renderSidebar() {
    // Sort payloads by timestamp in descending order
    payloads.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    callbackList.innerHTML = '';
    payloads.forEach((payload, idx) => {
      const li = document.createElement('li');
      li.dataset.idx = idx;
      const a = document.createElement('a');
      a.className = 'callback-link' + (selectedIdx === idx ? ' selected' : '');
      const method = (payload.method || '').toUpperCase();
      let methodClass = 'http-method-default';
      if (method === 'GET') methodClass = 'http-method-get';
      else if (method === 'POST') methodClass = 'http-method-post';
      else if (method === 'PUT') methodClass = 'http-method-put';
      else if (method === 'DELETE') methodClass = 'http-method-delete';
      else if (method === 'PATCH') methodClass = 'http-method-patch';

      a.innerHTML = `
        <span class='callback-link-content'><span>${formatDateEU(payload.timestamp)}</span><span class='http-method-badge ${methodClass}'>${escapeHtml(payload.method)}</span></span>
      `;
      a.href = '#';
      li.appendChild(a);
      callbackList.appendChild(li);
    });
  }

    function renderDetails() {
    if (selectedIdx === null || !payloads[selectedIdx]) {
      payloadDetails.innerHTML = 'No callback selected.';
      return;
    }

    const payload = payloads[selectedIdx];

    // Convert query object to query string
    const queryString = Object.entries(payload.query || {})
      .map(([key, value]) => `${key}=${value}`)
      .join('&');

    // Headers table
    let headersRows = '';
    for (const [key, value] of Object.entries(payload.headers || {})) {
      headersRows += `<tr class="headers-table-row"><td class="headers-table-cell"><span class="header-key">${escapeHtml(key)}</span></td><td class="headers-table-cell" style="display:flex;align-items:center;justify-content:space-between;"><span class="header-value">${escapeHtml(String(value))}</span><button class="copy-btn" data-copy="${escapeHtml(String(value))}" style="margin-left:auto;">Copy</button></td></tr>`;
    }

    const headersTable = `
      <div style="margin-bottom:18px;">
        <strong>Headers:</strong>
        <table style="width:100%;border-collapse:collapse;">
          <thead><tr><th style='text-align:left;'>Key</th><th style='text-align:left;'>Value</th></tr></thead>
          <tbody>${headersRows}</tbody>
        </table>
      </div>
    `;

    payloadDetails.innerHTML = `
      <div style="margin-bottom:12px;"><strong>Method:</strong> ${escapeHtml(payload.method)}<br><strong>Timestamp:</strong> ${escapeHtml(payload.timestamp)}</div>
      ${headersTable}
      <div><strong>Payload:</strong>
        <span style="float:right;display:flex;align-items:center;gap:8px;">
          <label style="font-weight:normal;font-size:0.95em;">
            <input type="checkbox" id="format-json-toggle" checked> Format JSON
          </label>
          <button id="copy-raw-json-btn" class="copy-btn">Copy Raw JSON</button>
        </span>
      </div>
      <div id="json-payload-view"></div>
      <div style="margin-top:12px;">
        <strong>Query String:</strong>
        <button id="copy-query-string-btn" class="copy-btn" style="float:right;">Copy Query String</button>
      </div>
      <div class="query-body">${escapeHtml(queryString)}</div>
    `;

    // Copy button logic for headers
    document.querySelectorAll('.copy-btn').forEach(btn => {
      if (btn.id !== 'copy-raw-json-btn') {
        btn.onclick = function() {
          navigator.clipboard.writeText(this.getAttribute('data-copy'));
          showCopySuccess();
        };
      }
    });

    // JSON payload logic
    const jsonPayloadView = document.getElementById('json-payload-view');
    const formatToggle = document.getElementById('format-json-toggle');
    const copyRawBtn = document.getElementById('copy-raw-json-btn');
    const copyQueryStringBtn = document.getElementById('copy-query-string-btn');

    let rawJson = '';
    if (payload.body && Object.keys(payload.body).length > 0) {
      rawJson = JSON.stringify(payload.body);
      function updateJsonView() {
        if (formatToggle.checked) {
          jsonPayloadView.innerHTML = `<pre class="json-body">${syntaxHighlight(payload.body)}</pre>`;
        } else {
          jsonPayloadView.innerHTML = `<pre class="json-body">${escapeHtml(rawJson)}</pre>`;
        }
      }
      formatToggle.onchange = updateJsonView;
      updateJsonView();
      copyRawBtn.onclick = function() {
        navigator.clipboard.writeText(rawJson);
        showCopySuccess();
      };
    } else {
      jsonPayloadView.innerHTML = '<em>No JSON body</em>';
      copyRawBtn.onclick = function() {
        navigator.clipboard.writeText('');
        showCopySuccess();
      };
    }

    copyQueryStringBtn.onclick = function() {
      navigator.clipboard.writeText(queryString);
      showCopySuccess();
    };
  }
    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, function(tag) {
        const chars = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'};
        return chars[tag] || tag;
      });
    }
    function syntaxHighlight(json) {
      if (typeof json != 'string') json = JSON.stringify(json, null, 2);
      json = escapeHtml(json);
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|\d+)/g, function (match) {
        let cls = 'number';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = 'key';
          } else {
            cls = 'string';
          }
        } else if (/true|false/.test(match)) {
          cls = 'boolean';
        } else if (/null/.test(match)) {
          cls = 'null';
        }
        return `<span class="json-${cls}">${match}</span>`;
      });
    }
    function showCopySuccess() {
      const el = document.getElementById('copy-success');
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 1000);
    }

    // Use event delegation for sidebar clicks
    callbackList.onclick = function(e) {
      let li = e.target;
      // Traverse up to the <li> if needed
      while (li && li !== callbackList && !li.dataset.idx) {
        li = li.parentElement;
      }
      if (li && li.dataset.idx) {
        e.preventDefault();
        const idx = parseInt(li.dataset.idx, 10);
        if (!isNaN(idx)) {
          selectedIdx = idx;
          renderSidebar();
          renderDetails();
        }
      }
    };

    // Variable to keep track of the number of new items
    let newItemCount = 0;

    // Function to update the document title
    function updateTitle() {
      console.log('Updating title with new item count:', newItemCount);
      if (newItemCount > 0) {
        document.title = `(${newItemCount}) Webhook Inspector`;
      } else {
        document.title = 'Webhook Inspector';
      }
    }

    socket.on('init', (data) => {
      console.log('Init webhook'); // Debugging line
      payloads = data;
      selectedIdx = payloads.length > 0 ? 0 : null;
      renderSidebar();
      renderDetails();
      updateTitle();
    });

    socket.on('webhook', (payload) => {
      console.log('New webhook received'); // Debugging line
      newItemCount++;
      updateTitle();

      payloads.unshift(payload);
      selectedIdx = 0;
      renderSidebar();
      renderDetails();
    });

    document.getElementById('reset-btn').onclick = async function() {
      if (!confirm('Are you sure you want to clear all cached webhook data?')) return;
      await fetch('/reset/' + sessionId, { method: 'POST' });
      payloads = [];
      selectedIdx = null;
      renderSidebar();
      renderDetails();
      updateTitle();
    };

    // Listen for visibility change to reset the new item count
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        newItemCount = 0;
        updateTitle();
      }
    });
  </script>
</body>
</html>